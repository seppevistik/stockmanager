<div class="form-container">
  <div class="form-header">
    <button mat-icon-button (click)="cancel()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Receive Goods</h1>
  </div>

  <mat-card>
    <mat-card-content>
      <!-- Loading Spinner -->
      @if (loading) {
        <div class="loading-spinner">
          <mat-spinner></mat-spinner>
        </div>
      }

      <!-- Form -->
      @if (!loading && purchaseOrder) {
        <!-- PO Information -->
        <div class="po-info-section">
          <h3>Purchase Order Information</h3>
          <div class="po-info-grid">
            <div class="info-item">
              <label>Order Number:</label>
              <span class="value">{{ purchaseOrder.orderNumber }}</span>
            </div>
            <div class="info-item">
              <label>Supplier:</label>
              <span class="value">{{ purchaseOrder.companyName }}</span>
            </div>
            <div class="info-item">
              <label>Order Date:</label>
              <span class="value">{{ purchaseOrder.orderDate | date:'shortDate' }}</span>
            </div>
            <div class="info-item">
              <label>Expected Delivery:</label>
              <span class="value">{{ purchaseOrder.expectedDeliveryDate ? (purchaseOrder.expectedDeliveryDate | date:'shortDate') : '-' }}</span>
            </div>
          </div>
        </div>

        <form [formGroup]="receiptForm" (ngSubmit)="onSubmit()">
          <!-- Receipt Header Information -->
          <div class="form-row two-columns">
            <mat-form-field appearance="outline">
              <mat-label>Receipt Date</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="receiptDate" required>
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Supplier Delivery Note</mat-label>
              <input matInput formControlName="supplierDeliveryNote" placeholder="Enter delivery note number">
            </mat-form-field>
          </div>

          <!-- Line Items -->
          <div class="line-items-section">
            <div class="section-header">
              <h3>Items to Receive</h3>
            </div>

            @if (lines.length === 0) {
              <div class="empty-state">
                <mat-icon>inventory_2</mat-icon>
                <p>No outstanding items to receive for this purchase order.</p>
              </div>
            }

            @if (lines.length > 0) {
              <div class="table-container">
                <table mat-table [dataSource]="lines.controls" class="receipt-table">
                  <!-- Product Column -->
                  <ng-container matColumnDef="product">
                    <th mat-header-cell *matHeaderCellDef>Product</th>
                    <td mat-cell *matCellDef="let line">
                      <div class="product-info">
                        <strong>{{ line.get('productName')?.value }}</strong>
                        <span class="product-sku">{{ line.get('productSku')?.value }}</span>
                      </div>
                    </td>
                  </ng-container>

                  <!-- Ordered Quantity Column -->
                  <ng-container matColumnDef="ordered">
                    <th mat-header-cell *matHeaderCellDef>Ordered</th>
                    <td mat-cell *matCellDef="let line">
                      {{ line.get('quantityOrdered')?.value }}
                    </td>
                  </ng-container>

                  <!-- Outstanding Quantity Column -->
                  <ng-container matColumnDef="outstanding">
                    <th mat-header-cell *matHeaderCellDef>Outstanding</th>
                    <td mat-cell *matCellDef="let line">
                      <span class="outstanding-qty">{{ line.get('quantityOutstanding')?.value }}</span>
                    </td>
                  </ng-container>

                  <!-- Receiving Quantity Column -->
                  <ng-container matColumnDef="receiving">
                    <th mat-header-cell *matHeaderCellDef>Receiving</th>
                    <td mat-cell *matCellDef="let line; let i = index">
                      <mat-form-field appearance="outline" class="compact-field">
                        <input matInput type="number" [formControl]="line.get('quantityReceived')" min="0" [max]="line.get('quantityOutstanding')?.value">
                      </mat-form-field>
                    </td>
                  </ng-container>

                  <!-- Condition Column -->
                  <ng-container matColumnDef="condition">
                    <th mat-header-cell *matHeaderCellDef>Condition</th>
                    <td mat-cell *matCellDef="let line; let i = index">
                      <mat-form-field appearance="outline" class="compact-field">
                        <mat-select [formControl]="line.get('condition')" (selectionChange)="onConditionChange(i)">
                          @for (option of conditionOptions; track option.value) {
                            <mat-option [value]="option.value">{{ option.label }}</mat-option>
                          }
                        </mat-select>
                      </mat-form-field>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
              </div>

              <!-- Expandable Details for Each Line -->
              <div class="line-details-section" formArrayName="lines">
                @for (line of lines.controls; track line; let i = $index) {
                  <mat-card class="line-detail-card" [formGroupName]="i">
                    <mat-card-content>
                      <div class="detail-header">
                        <strong>{{ line.get('productName')?.value }}</strong>
                      </div>

                      <div class="detail-fields">
                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>Unit Price Received (Optional)</mat-label>
                          <input matInput type="number" formControlName="unitPriceReceived" step="0.01" min="0">
                          <span matPrefix>$&nbsp;</span>
                          <mat-hint>Leave blank to use ordered price: ${{ line.get('unitPriceOrdered')?.value }}</mat-hint>
                        </mat-form-field>

                        @if (line.get('condition')?.value === 'Damaged' || line.get('condition')?.value === 'Defective') {
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Damage Notes</mat-label>
                            <textarea matInput formControlName="damageNotes" rows="2" placeholder="Describe the damage or defect"></textarea>
                            <mat-error>Damage notes are required for damaged or defective items</mat-error>
                          </mat-form-field>
                        }

                        <div class="detail-row">
                          <mat-form-field appearance="outline">
                            <mat-label>Location</mat-label>
                            <input matInput formControlName="location" placeholder="Storage location">
                          </mat-form-field>

                          <mat-form-field appearance="outline">
                            <mat-label>Batch Number</mat-label>
                            <input matInput formControlName="batchNumber" placeholder="Batch/Lot number">
                          </mat-form-field>

                          <mat-form-field appearance="outline">
                            <mat-label>Expiry Date</mat-label>
                            <input matInput [matDatepicker]="expiryPicker" formControlName="expiryDate">
                            <mat-datepicker-toggle matSuffix [for]="expiryPicker"></mat-datepicker-toggle>
                            <mat-datepicker #expiryPicker></mat-datepicker>
                          </mat-form-field>
                        </div>
                      </div>
                    </mat-card-content>
                  </mat-card>
                }
              </div>
            }
          </div>

          <!-- General Notes -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Receipt Notes</mat-label>
            <textarea matInput formControlName="notes" rows="3" placeholder="Any additional notes about this receipt"></textarea>
          </mat-form-field>

          <!-- Error Message -->
          @if (errorMessage) {
            <div class="error-message">
              {{ errorMessage }}
            </div>
          }

          <!-- Form Actions -->
          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="cancel()" [disabled]="saving">
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="saving || receiptForm.invalid">
              @if (saving) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <ng-container>
                  <mat-icon>save</mat-icon>
                  <span>Save Receipt</span>
                </ng-container>
              }
            </button>
          </div>
        </form>
      }
    </mat-card-content>
  </mat-card>
</div>
