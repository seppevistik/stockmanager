<div class="purchase-order-detail-container">
  <div class="header">
    <button mat-icon-button (click)="back()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Purchase Order Details</h1>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!loading && purchaseOrder">
    <!-- Header Information Card -->
    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>
          {{ purchaseOrder.orderNumber }}
          <mat-chip>
            {{ purchaseOrder.status }}
          </mat-chip>
        </mat-card-title>
        <mat-card-subtitle>{{ purchaseOrder.companyName }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <label>Order Date:</label>
            <span>{{ purchaseOrder.orderDate | date: 'mediumDate' }}</span>
          </div>
          <div class="info-item" *ngIf="purchaseOrder.expectedDeliveryDate">
            <label>Expected Delivery:</label>
            <span>{{ purchaseOrder.expectedDeliveryDate | date: 'mediumDate' }}</span>
          </div>
          <div class="info-item" *ngIf="purchaseOrder.confirmedDeliveryDate">
            <label>Confirmed Delivery:</label>
            <span>{{ purchaseOrder.confirmedDeliveryDate | date: 'mediumDate' }}</span>
          </div>
          <div class="info-item">
            <label>Created By:</label>
            <span>{{ purchaseOrder.createdByName }}</span>
          </div>
          <div class="info-item">
            <label>Created At:</label>
            <span>{{ purchaseOrder.createdAt | date: 'medium' }}</span>
          </div>
          <div class="info-item" *ngIf="purchaseOrder.supplierReference">
            <label>Supplier Reference:</label>
            <span>{{ purchaseOrder.supplierReference }}</span>
          </div>
          <div class="info-item" *ngIf="purchaseOrder.submittedAt">
            <label>Submitted At:</label>
            <span>{{ purchaseOrder.submittedAt | date: 'medium' }}</span>
          </div>
          <div class="info-item" *ngIf="purchaseOrder.completedAt">
            <label>Completed At:</label>
            <span>{{ purchaseOrder.completedAt | date: 'medium' }}</span>
          </div>
          <div class="info-item" *ngIf="purchaseOrder.cancelledAt">
            <label>Cancelled At:</label>
            <span>{{ purchaseOrder.cancelledAt | date: 'medium' }}</span>
          </div>
        </div>
        <div class="info-item full-width" *ngIf="purchaseOrder.notes">
          <label>Notes:</label>
          <p>{{ purchaseOrder.notes }}</p>
        </div>
        <div class="info-item full-width" *ngIf="purchaseOrder.cancellationReason">
          <label>Cancellation Reason:</label>
          <p class="error-text">{{ purchaseOrder.cancellationReason }}</p>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-raised-button color="primary" *ngIf="canEdit()" (click)="onEdit()" [disabled]="actionInProgress">
          <mat-icon>edit</mat-icon> Edit
        </button>
        <button mat-raised-button color="accent" *ngIf="canSubmit()" (click)="onSubmit()" [disabled]="actionInProgress">
          <mat-icon>send</mat-icon> Submit
        </button>
        <button mat-raised-button color="accent" *ngIf="canConfirm()" (click)="onConfirm()" [disabled]="actionInProgress">
          <mat-icon>check_circle</mat-icon> Confirm
        </button>
        <button mat-raised-button color="primary" *ngIf="canCreateReceipt()" (click)="onCreateReceipt()" [disabled]="actionInProgress">
          <mat-icon>add</mat-icon> Create Receipt
        </button>
        <button mat-raised-button color="warn" *ngIf="canCancel()" (click)="onCancel()" [disabled]="actionInProgress">
          <mat-icon>cancel</mat-icon> Cancel Order
        </button>
        <button mat-button color="warn" *ngIf="canDelete()" (click)="onDelete()" [disabled]="actionInProgress">
          <mat-icon>delete</mat-icon> Delete
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Line Items -->
    <mat-card class="lines-card">
      <mat-card-header>
        <mat-card-title>Order Lines</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="purchaseOrder.lines" class="full-width">
          <!-- Product SKU Column -->
          <ng-container matColumnDef="productSku">
            <th mat-header-cell *matHeaderCellDef>SKU</th>
            <td mat-cell *matCellDef="let line">{{ line.productSku }}</td>
          </ng-container>

          <!-- Product Name Column -->
          <ng-container matColumnDef="productName">
            <th mat-header-cell *matHeaderCellDef>Product</th>
            <td mat-cell *matCellDef="let line">{{ line.productName }}</td>
          </ng-container>

          <!-- Quantity Ordered Column -->
          <ng-container matColumnDef="quantityOrdered">
            <th mat-header-cell *matHeaderCellDef>Ordered</th>
            <td mat-cell *matCellDef="let line">{{ line.quantityOrdered }}</td>
          </ng-container>

          <!-- Quantity Received Column -->
          <ng-container matColumnDef="quantityReceived">
            <th mat-header-cell *matHeaderCellDef>Received</th>
            <td mat-cell *matCellDef="let line">{{ line.quantityReceived }}</td>
          </ng-container>

          <!-- Quantity Outstanding Column -->
          <ng-container matColumnDef="quantityOutstanding">
            <th mat-header-cell *matHeaderCellDef>Outstanding</th>
            <td mat-cell *matCellDef="let line">{{ line.quantityOutstanding }}</td>
          </ng-container>

          <!-- Unit Price Column -->
          <ng-container matColumnDef="unitPrice">
            <th mat-header-cell *matHeaderCellDef>Unit Price</th>
            <td mat-cell *matCellDef="let line">{{ line.unitPrice | currency }}</td>
          </ng-container>

          <!-- Line Total Column -->
          <ng-container matColumnDef="lineTotal">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let line">{{ line.lineTotal | currency }}</td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let line">
              <mat-chip [color]="getLineStatusColor(line.status)" class="status-chip">
                {{ line.status }}
              </mat-chip>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- Totals -->
        <div class="totals-section">
          <div class="total-row">
            <span class="label">Subtotal:</span>
            <span class="value">{{ purchaseOrder.subTotal | currency }}</span>
          </div>
          <div class="total-row">
            <span class="label">Tax:</span>
            <span class="value">{{ purchaseOrder.taxAmount | currency }}</span>
          </div>
          <div class="total-row">
            <span class="label">Shipping:</span>
            <span class="value">{{ purchaseOrder.shippingCost | currency }}</span>
          </div>
          <div class="total-row grand-total">
            <span class="label">Total:</span>
            <span class="value">{{ purchaseOrder.totalAmount | currency }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Receipts -->
    <mat-card class="receipts-card" *ngIf="receipts.length > 0">
      <mat-card-header>
        <mat-card-title>Receipts</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="receipts" class="full-width">
          <!-- Receipt Number Column -->
          <ng-container matColumnDef="receiptNumber">
            <th mat-header-cell *matHeaderCellDef>Receipt Number</th>
            <td mat-cell *matCellDef="let receipt">{{ receipt.receiptNumber }}</td>
          </ng-container>

          <!-- Receipt Date Column -->
          <ng-container matColumnDef="receiptDate">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let receipt">{{ receipt.receiptDate | date: 'mediumDate' }}</td>
          </ng-container>

          <!-- Received By Column -->
          <ng-container matColumnDef="receivedByName">
            <th mat-header-cell *matHeaderCellDef>Received By</th>
            <td mat-cell *matCellDef="let receipt">{{ receipt.receivedByName }}</td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let receipt">
              <mat-chip [color]="getReceiptStatusColor(receipt.status)" class="status-chip">
                {{ getReceiptStatusLabel(receipt.status) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let receipt">
              <button mat-icon-button (click)="viewReceipt(receipt)" matTooltip="View Receipt">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="receiptsColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: receiptsColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="!loading && !purchaseOrder" class="error-container">
    <p>Purchase order not found</p>
  </div>
</div>
